<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tic Tac Toe Ultra</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6C63FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Premium Icons & Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #6C63FF;
            --secondary: #00D2FF;
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #ffffff;
            --text-sub: #94a3b8;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            --radius: 24px;
            --font: 'Outfit', sans-serif;
            --anim: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Light Mode Override */
        [data-theme="light"] {
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: 1px solid rgba(0, 0, 0, 0.05);
            --shadow: 0 10px 30px -10px rgba(100, 116, 139, 0.2);
        }

        /* --- GLOBAL RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            font-family: var(--font);
            background: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            transition: background 0.5s ease;
        }

        /* --- BACKGROUND ANIMATION --- */
        .blobs { position: absolute; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .blob {
            position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.4;
            animation: float 10s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: var(--primary); }
        .blob-2 { bottom: -10%; right: -10%; width: 250px; height: 250px; background: var(--secondary); animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 50px); } }

        /* --- APP SHELL --- */
        #app {
            width: 100%; height: 100%; max-width: 450px;
            position: relative;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: opacity 0.4s var(--anim), transform 0.4s var(--anim);
        }
        .screen.active { opacity: 1; pointer-events: all; transform: scale(1); }
        
        /* Transition utility */
        .screen.slide-out { transform: translateY(-20px); opacity: 0; }
        .screen.slide-in { transform: translateY(20px); opacity: 0; }

        /* --- SPLASH SCREEN --- */
        #splash { z-index: 1000; background: var(--bg-color); transition: opacity 0.5s ease; }
        .logo-wrapper {
            width: 120px; height: 120px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 30px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 50px rgba(108, 99, 255, 0.4);
            animation: breathe 2s infinite ease-in-out;
        }
        .logo-wrapper img { width: 70px; height: 70px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* --- UI ELEMENTS --- */
        h1 { font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p.subtitle { color: var(--text-sub); margin-bottom: 40px; font-weight: 300; }

        .btn {
            width: 100%; padding: 18px; margin-bottom: 15px;
            background: var(--card-bg);
            border: var(--border); border-radius: 20px;
            color: var(--text-main); font-size: 1.1rem; font-weight: 600;
            display: flex; align-items: center; justify-content: space-between;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--shadow); cursor: pointer;
            transition: transform 0.2s var(--anim), background 0.3s;
        }
        .btn:active { transform: scale(0.97); }
        .btn i { color: var(--primary); font-size: 1.3rem; }
        .btn-install { border: 2px solid var(--primary); background: rgba(108, 99, 255, 0.1); display: none; }
        
        /* Hide Install Button in App Mode */
        @media all and (display-mode: standalone) { .btn-install { display: none !important; } }

        /* --- GAME BOARD --- */
        .scoreboard {
            display: flex; justify-content: space-between; width: 100%; margin-bottom: 30px;
            background: var(--card-bg); padding: 15px 25px; border-radius: 20px; border: var(--border);
        }
        .score-box { text-align: center; }
        .score-val { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .score-label { font-size: 0.8rem; color: var(--text-sub); }

        .grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            width: 100%; max-width: 350px; aspect-ratio: 1;
            margin-bottom: 30px;
        }
        .cell {
            background: var(--card-bg); border-radius: 18px; border: var(--border);
            display: flex; justify-content: center; align-items: center;
            font-size: 3rem; cursor: pointer; position: relative; overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .cell:active { background: rgba(255,255,255,0.05); }
        .cell span { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cell.win { background: rgba(108, 99, 255, 0.2); border-color: var(--primary); }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- SETTINGS MODAL --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            z-index: 500; opacity: 0; pointer-events: none;
            display: flex; align-items: flex-end; transition: opacity 0.3s;
        }
        .modal.open { opacity: 1; pointer-events: all; }
        .sheet {
            width: 100%; background: var(--bg-color);
            border-radius: 30px 30px 0 0; padding: 30px;
            border-top: 1px solid var(--text-sub);
            transform: translateY(100%); transition: transform 0.3s var(--anim);
        }
        .modal.open .sheet { transform: translateY(0); }

        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid var(--border);
        }
        .toggle {
            width: 50px; height: 28px; background: var(--text-sub); border-radius: 14px;
            position: relative; transition: 0.3s;
        }
        .toggle::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px;
            background: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle.on { background: var(--primary); }
        .toggle.on::after { transform: translateX(22px); }
        
        input[type="text"] {
            width: 100%; background: var(--card-bg); border: var(--border); padding: 15px;
            border-radius: 15px; color: var(--text-main); font-size: 1rem; margin-bottom: 10px;
        }

        /* --- COLOR PICKER CUSTOM --- */
        .color-options { display: flex; gap: 10px; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: var(--text-main); transform: scale(1.1); }

    </style>
</head>
<body>

    <!-- Background Ambience -->
    <div class="blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div id="app">
        
        <!-- 1. SPLASH SCREEN -->
        <div id="splash" class="screen active">
            <div class="logo-wrapper">
                <!-- App Logo Link -->
                <img src="https://cdn-icons-png.flaticon.com/512/3569/3569998.png" alt="App Logo">
            </div>
            <h2 style="margin-top: 20px; font-weight: 400; letter-spacing: 2px;">TIC TAC ULTRA</h2>
        </div>

        <!-- 2. HOME SCREEN -->
        <div id="home" class="screen">
            <img src="https://cdn-icons-png.flaticon.com/512/3569/3569998.png" style="width:80px; margin-bottom:20px;" alt="">
            <h1>Welcome</h1>
            <p class="subtitle">Choose your game mode</p>
            
            <div class="btn" onclick="app.showNameInput()">
                <span>Play vs Friend</span> <i class="fas fa-user-friends"></i>
            </div>
            <div class="btn" onclick="app.startGame('cpu')">
                <span>Play vs Computer</span> <i class="fas fa-robot"></i>
            </div>
            <div class="btn" onclick="app.toggleSettings(true)">
                <span>Settings</span> <i class="fas fa-cog"></i>
            </div>
            <!-- Download Button (Hidden in PWA) -->
            <div class="btn btn-install" id="installBtn">
                <span>Download App</span> <i class="fas fa-download"></i>
            </div>
        </div>

        <!-- 3. GAME SCREEN -->
        <div id="game" class="screen">
            <div class="scoreboard">
                <div class="score-box">
                    <div id="p1-name" class="score-label">You</div>
                    <div id="score-x" class="score-val">0</div>
                </div>
                <div class="score-box" style="display:flex; align-items:center;">
                    <div style="background:var(--card-bg); padding:5px 15px; border-radius:20px; font-size:0.9rem;" id="turn-txt">X Turn</div>
                </div>
                <div class="score-box">
                    <div id="p2-name" class="score-label">CPU</div>
                    <div id="score-o" class="score-val">0</div>
                </div>
            </div>

            <div class="grid" id="board"></div>

            <div class="btn" onclick="app.restartMatch()">
                <span>Restart Match</span> <i class="fas fa-redo"></i>
            </div>
            <div class="btn" style="background:transparent; border:none; box-shadow:none;" onclick="app.nav('home')">
                <span>Exit Game</span> <i class="fas fa-arrow-left"></i>
            </div>
        </div>

    </div>

    <!-- 4. MODALS -->
    <!-- Name Input -->
    <div id="modal-names" class="modal">
        <div class="sheet">
            <h3>Enter Player Names</h3>
            <br>
            <input type="text" id="input-p1" placeholder="Player 1 Name" value="Player 1">
            <input type="text" id="input-p2" placeholder="Player 2 Name" value="Player 2">
            <div class="btn" style="background:var(--primary); color:white; margin-top:10px; justify-content:center;" onclick="app.startGame('friend')">Start Game</div>
            <div class="btn" style="justify-content:center;" onclick="document.getElementById('modal-names').classList.remove('open')">Cancel</div>
        </div>
    </div>

    <!-- Settings -->
    <div id="modal-settings" class="modal">
        <div class="sheet">
            <h3>Settings</h3>
            <div class="setting-row">
                <span>Sound Effects</span>
                <div class="toggle on" id="tog-sound" onclick="app.toggleSound()"></div>
            </div>
            <div class="setting-row">
                <span>Dark / White Mode</span>
                <div class="toggle" id="tog-theme" onclick="app.toggleTheme()"></div>
            </div>
            <div class="setting-row" style="flex-direction:column; align-items:flex-start; gap:10px;">
                <span>Board Color</span>
                <div class="color-options">
                    <div class="color-dot" style="background:#6C63FF" onclick="app.setBoardColor('#6C63FF')"></div>
                    <div class="color-dot" style="background:#FF5F6D" onclick="app.setBoardColor('#FF5F6D')"></div>
                    <div class="color-dot" style="background:#00D2FF" onclick="app.setBoardColor('#00D2FF')"></div>
                    <div class="color-dot" style="background:#00b09b" onclick="app.setBoardColor('#00b09b')"></div>
                </div>
            </div>
            <div class="btn" style="margin-top:20px; justify-content:center;" onclick="app.toggleSettings(false)">Close</div>
        </div>
    </div>

    <script>
        const app = {
            state: {
                screen: 'splash',
                board: Array(9).fill(null),
                turn: 'X',
                active: false,
                mode: 'cpu',
                scores: { X:0, O:0 },
                p1: 'You',
                p2: 'CPU',
                settings: { sound: true, dark: true }
            },
            
            // Audio Engine (Synth - No files needed)
            audioCtx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone: (type) => {
                if(!app.state.settings.sound) return;
                if(app.audioCtx.state === 'suspended') app.audioCtx.resume();
                const osc = app.audioCtx.createOscillator();
                const gain = app.audioCtx.createGain();
                
                if(type === 'click') {
                    osc.frequency.setValueAtTime(600, app.audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.05, app.audioCtx.currentTime);
                    osc.stop(app.audioCtx.currentTime + 0.05);
                } else if(type === 'win') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(400, app.audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(800, app.audioCtx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.1, app.audioCtx.currentTime);
                    osc.stop(app.audioCtx.currentTime + 0.3);
                }
                osc.connect(gain); gain.connect(app.audioCtx.destination); osc.start();
            },

            init: () => {
                // Generate Board
                const grid = document.getElementById('board');
                grid.innerHTML = '';
                for(let i=0; i<9; i++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.onclick = () => app.handleMove(i);
                    grid.appendChild(cell);
                }
                
                // Splash Timer
                setTimeout(() => {
                    document.getElementById('splash').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('splash').style.display = 'none';
                        app.nav('home');
                    }, 500);
                }, 2000);
            },

            nav: (screenId) => {
                app.playTone('click');
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            },

            showNameInput: () => {
                app.playTone('click');
                document.getElementById('modal-names').classList.add('open');
            },

            startGame: (mode) => {
                app.state.mode = mode;
                if(mode === 'friend') {
                    app.state.p1 = document.getElementById('input-p1').value || 'P1';
                    app.state.p2 = document.getElementById('input-p2').value || 'P2';
                    document.getElementById('modal-names').classList.remove('open');
                } else {
                    app.state.p1 = 'You';
                    app.state.p2 = 'Computer';
                }
                
                // Update UI Labels
                document.getElementById('p1-name').innerText = app.state.p1;
                document.getElementById('p2-name').innerText = app.state.p2;
                app.state.scores = { X:0, O:0 };
                app.updateScore();
                
                app.restartMatch();
                app.nav('game');
            },

            restartMatch: () => {
                app.state.board.fill(null);
                app.state.turn = 'X';
                app.state.active = true;
                document.querySelectorAll('.cell').forEach(c => {
                    c.innerHTML = ''; 
                    c.classList.remove('win');
                    c.style.color = 'var(--text-main)';
                });
                document.getElementById('turn-txt').innerText = `${app.state.p1}'s Turn`;
                app.playTone('click');
            },

            handleMove: (i) => {
                if(!app.state.active || app.state.board[i]) return;
                if(app.state.mode === 'cpu' && app.state.turn === 'O') return;

                app.placeMark(i, app.state.turn);
                
                if(app.state.active && app.state.mode === 'cpu' && app.state.turn === 'O') {
                    setTimeout(app.cpuMove, 500);
                }
            },

            placeMark: (i, player) => {
                app.state.board[i] = player;
                const cell = document.getElementById('board').children[i];
                cell.innerHTML = player === 'X' 
                    ? `<span style="color:var(--secondary)"><i class="fas fa-times"></i></span>` 
                    : `<span style="color:var(--primary)"><i class="far fa-circle"></i></span>`;
                
                app.playTone('click');
                
                const winCombo = app.checkWin(player);
                if(winCombo) {
                    app.endGame(player, winCombo);
                } else if(!app.state.board.includes(null)) {
                    app.endGame('draw');
                } else {
                    app.state.turn = player === 'X' ? 'O' : 'X';
                    const name = app.state.turn === 'X' ? app.state.p1 : app.state.p2;
                    document.getElementById('turn-txt').innerText = `${name}'s Turn`;
                }
            },

            cpuMove: () => {
                // Logic: 1. Win, 2. Block, 3. Random
                let move = -1;
                const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                
                const findSpot = (p) => {
                    for(let c of wins) {
                        const vals = c.map(k => app.state.board[k]);
                        if(vals.filter(v => v === p).length === 2 && vals.includes(null)) 
                            return c[vals.indexOf(null)];
                    }
                    return -1;
                };

                move = findSpot('O'); // Try Win
                if(move === -1) move = findSpot('X'); // Block
                if(move === -1) {
                    const empty = app.state.board.map((v,k) => v===null?k:null).filter(v=>v!==null);
                    move = empty[Math.floor(Math.random()*empty.length)];
                }
                
                if(move !== undefined) app.placeMark(move, 'O');
            },

            checkWin: (p) => {
                const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                return wins.find(c => c.every(k => app.state.board[k] === p));
            },

            endGame: (winner, combo) => {
                app.state.active = false;
                if(winner === 'draw') {
                    document.getElementById('turn-txt').innerText = "It's a Draw!";
                } else {
                    app.state.scores[winner]++;
                    app.updateScore();
                    const name = winner === 'X' ? app.state.p1 : app.state.p2;
                    document.getElementById('turn-txt').innerText = `${name} Wins!`;
                    if(combo) combo.forEach(idx => document.getElementById('board').children[idx].classList.add('win'));
                    app.playTone('win');
                    // Vibrate
                    if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            },

            updateScore: () => {
                document.getElementById('score-x').innerText = app.state.scores.X;
                document.getElementById('score-o').innerText = app.state.scores.O;
            },

            // Settings Logic
            toggleSettings: (show) => {
                app.playTone('click');
                const m = document.getElementById('modal-settings');
                show ? m.classList.add('open') : m.classList.remove('open');
            },
            toggleSound: () => {
                app.state.settings.sound = !app.state.settings.sound;
                document.getElementById('tog-sound').classList.toggle('on');
            },
            toggleTheme: () => {
                const isDark = document.body.getAttribute('data-theme') !== 'light';
                document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
                document.getElementById('tog-theme').classList.toggle('on');
            },
            setBoardColor: (c) => {
                document.documentElement.style.setProperty('--primary', c);
            }
        };

        window.onload = app.init;

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installBtn');
            btn.style.display = 'flex';
            
            btn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((res) => {
                    if(res.outcome === 'accepted') btn.style.display = 'none';
                    deferredPrompt = null;
                });
            });
        });

        // Service Worker Reg
        if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
    </script>
</body>
</html>